<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDG Robotics Track</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load futuristic fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Exo+2:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- Base Setup --- */
        body {
            font-family: 'Exo 2', 'Inter', sans-serif;
            background-color: #0c1427; /* Dark blueprint blue */
            color: #00e5ff;
            overflow: hidden;
            /* Blueprint grid background */
            background-image: 
                linear-gradient(rgba(0, 229, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 229, 255, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            animation: pan-background 60s linear infinite;
        }

        @keyframes pan-background {
            from { background-position: 0 0; }
            to { background-position: 400px 400px; }
        }

        .font-hud-title {
            font-family: 'Orbitron', sans-serif;
        }
        
        /* --- Start Button --- */
        #start-button {
            background: #00e5ff;
            color: #0c1427;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            padding: 20px 40px;
            border: 2px solid #00e5ff;
            box-shadow: 0 0 30px #00e5ff;
            transition: all 0.3s ease;
            cursor: pointer;
            animation: pulse-button 2s infinite alternate;
        }
        #start-button:hover {
            background: transparent;
            color: #00e5ff;
            box-shadow: 0 0 40px #00e5ff, inset 0 0 10px #00e5ff;
        }
        @keyframes pulse-button {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }
        
        /* --- Robot Assembly Area --- */
        #assembly-container {
            position: relative;
            width: 400px;
            height: 600px;
            /* Dashed blueprint outline */
            border: 2px dashed rgba(0, 229, 255, 0.3);
            transition: all 0.5s ease-out;
            /* Futuristic scanner line effect */
            overflow: hidden;
        }
        
        /* Scanner Line */
        #assembly-container::before {
            content: '';
            position: absolute;
            left: 0;
            top: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(0, 229, 255, 0) 0%, rgba(0, 229, 255, 0.2) 50%, rgba(0, 229, 255, 0) 100%);
            animation: scan-line 4s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }

        /* Scanner line animation */
        @keyframes scan-line {
            0% {
                transform: translateY(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(200%); /* 100% (element height) + 100% (to move offscreen) */
                opacity: 0;
            }
        }
        
        /* This rule gets added by JS to show the scanner */
        #assembly-container.scanning::before {
            opacity: 1;
        }

        /* SVG Robot Part Styling */
        .robot-part {
            position: absolute;
            fill: none;
            stroke: #00e5ff; /* Default blueprint blue */
            stroke-width: 2;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), stroke 0.3s ease, box-shadow 0.3s ease; /* Overshoot "snap" */
            will-change: transform, opacity, stroke;
        }
        
        /* Error state for robot parts */
        .robot-part.alert {
            stroke: #ff4d4d !important; /* Red alert */
            box-shadow: 0 0 15px #ff4d4d;
        }
        
        /* Success state for robot parts (New) */
        .robot-part.success {
            stroke: #4dff4d !important; /* Bright green */
            box-shadow: 0 0 15px #4dff4d;
        }


        /* --- Part Assembly States --- */

        /* Head */
        #robot-head {
            width: 150px;
            top: 50px;
            left: 125px;
            transform: translateY(-100px);
        }
        #robot-head.assembled {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Torso */
        #robot-torso {
            width: 200px;
            top: 200px;
            left: 100px;
            transform: translateY(-100px);
        }
        #robot-torso.assembled {
            opacity: 1;
            transform: translateY(0);
        }

        /* Legs */
        #robot-legs {
            width: 180px;
            top: 380px;
            left: 110px;
            transform: translateY(100px);
        }
        #robot-legs.assembled {
            opacity: 1;
            transform: translateY(0);
        }

        /* Arms */
        #robot-arm-left {
            width: 80px;
            top: 220px;
            left: 30px;
            transform: translateX(-100px);
        }
        #robot-arm-left.assembled {
            opacity: 1;
            transform: translateX(0);
        }
        #robot-arm-right {
            width: 80px;
            top: 220px;
            left: 290px;
            transform: translateX(100px);
        }
        #robot-arm-right.assembled {
            opacity: 1;
            transform: translateX(0);
        }
        
        /* Core (Lights up at the end) */
        #robot-core {
            position: absolute;
            width: 50px;
            height: 50px;
            top: 270px;
            left: 175px;
            border-radius: 50%;
            background: #00e5ff; /* Default blue */
            opacity: 0;
            transform: scale(0);
            box-shadow: 0 0 20px #00e5ff;
            transition: all 0.5s ease, background 0.3s ease, box-shadow 0.3s ease;
        }
        #robot-core.assembled {
            opacity: 1;
            transform: scale(1);
            animation: pulse-button 1s infinite alternate;
        }
        /* Error state for core */
        #robot-core.alert {
            background: #ff4d4d !important;
            box-shadow: 0 0 20px #ff4d4d !important;
        }
        /* Success state for core (New) */
        #robot-core.success {
            background: #4dff4d !important;
            box-shadow: 0 0 30px #4dff4d !important;
        }

        
        /* --- Question Prompt Box --- */
        #prompt-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center; /* Horizontally centers the prompt box */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-out;
            padding: 1.5rem; /* Adds spacing from the bottom edge */
        }
        #prompt-container.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #prompt-box {
            width: 90%;
            max-width: 500px;
            background: rgba(12, 20, 39, 0.9);
            border: 2px solid #00e5ff; /* Default blueprint blue */
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.5); /* Default blue */
            backdrop-filter: blur(5px);
            color: #fff;
            opacity: 0;
            transform: translateY(50px); /* Start 50px down (hidden) */
            transition: all 0.5s ease-out 0.3s, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #prompt-container.visible #prompt-box {
            opacity: 1;
            transform: translateY(0); /* Animate to final position */
        }
        /* Error state for prompt box */
        #prompt-box.alert {
            border-color: #ff4d4d !important;
            box-shadow: 0 0 30px rgba(255, 77, 77, 0.5) !important;
        }

        /* Shared input style */
        .hud-input, .hud-button {
            background: rgba(0, 50, 70, 0.7);
            border: 1px solid #00e5ff;
            color: #fff;
            font-family: 'Exo 2', sans-serif;
            border-radius: 4px;
            padding: 10px 14px;
            transition: all 0.3s ease;
        }
        .hud-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        .hud-input:focus {
            outline: none;
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.7);
            border-color: #fff;
        }
        .hud-input option {
            background: #00141e;
            color: #fff;
        }
        
        .hud-button {
            cursor: pointer;
            font-weight: 700;
            text-transform: uppercase;
        }
        .hud-button:hover {
            background: #00e5ff;
            color: #0c1427;
            box-shadow: 0 0 20px #00e5ff;
        }
        .hud-button:disabled {
            background: rgba(50, 50, 50, 0.5);
            color: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
        }

    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center p-4">

    <!-- ===== Start Button ===== -->
    <div id="start-container" class="text-center">
        <h1 class="font-hud-title text-4xl mb-4 text-white">GDG Robotics Track</h1>
        <h2 class="font-hud-title text-2xl mb-8 text-cyan-300">Registration Required</h2>
        <button id="start-button">Begin Assembly</button>
    </div>

    <!-- ===== Main Assembly UI (Hidden by default) ===== -->
    <div id="main-ui" class="hidden w-full h-full flex items-center justify-center">
        
        <!-- Robot Blueprint -->
        <div id="assembly-container">
            <!-- Robot Parts (SVGs) -->
            <!-- Head -->
            <svg id="robot-head" class="robot-part" viewBox="0 0 100 100">
                <rect x="15" y="10" width="70" height="60" rx="5" />
                <rect x="30" y="25" width="15" height="15" fill="#00e5ff" />
                <rect x="55" y="25" width="15" height="15" fill="#00e5ff" />
                <rect x="25" y="50" width="50" height="5" />
                <rect x="45" y="70" width="10" height="20" />
            </svg>
            <!-- Torso -->
            <svg id="robot-torso" class="robot-part" viewBox="0 0 100 100">
                <rect x="10" y="0" width="80" height="100" rx="10" />
            </svg>
            <!-- Legs -->
            <svg id="robot-legs" class="robot-part" viewBox="0 0 100 100">
                <rect x="10" y="0" width="30" height="80" rx="5" />
                <rect x="60" y="0" width="30" height="80" rx="5" />
                <rect x="5" y="80" width="40" height="15" rx="3" />
                <rect x="55" y="80" width="40" height="15" rx="3" />
            </svg>
            <!-- Left Arm -->
            <svg id="robot-arm-left" class="robot-part" viewBox="0 0 50 100">
                <rect x="10" y="0" width="30" height="80" rx="5" />
                <rect x="0" y="80" width="50" height="15" rx="3" />
            </svg>
            <!-- Right Arm -->
            <svg id="robot-arm-right" class="robot-part" viewBox="0 0 50 100">
                <rect x="10" y="0" width="30" height="80" rx="5" />
                <rect x="0" y="80" width="50" height="15" rx="3" />
            </svg>
            <!-- Core -->
            <div id="robot-core"></div>
        </div>
        
        <!-- Question Prompt -->
        <div id="prompt-container">
            <div id="prompt-box" class="p-6 space-y-4">
                <h2 id="prompt-title" class="font-hud-title text-xl text-center uppercase">Registration Question</h2>
                <p id="prompt-text" class="text-lg text-center text-white" style="min-height: 50px;"></p>
                
                <!-- Answer Area -->
                <div id="answer-area" class="space-y-4">
                    <!-- Standard Text Input -->
                    <div id="input-text-group" class="hidden flex flex-col">
                        <input type="text" id="prompt-input" class="hud-input w-full" placeholder="Enter response...">
                    </div>
                    
                    <!-- Choice Buttons -->
                    <div id="input-choice-group" class="hidden grid grid-cols-2 gap-4">
                        <!-- Buttons populated by JS -->
                    </div>
                    
                    <!-- Select Dropdown -->
                    <div id="input-select-group" class="hidden flex flex-col">
                        <select id="prompt-select" class="hud-input w-full">
                            <!-- Options populated by JS -->
                        </select>
                    </div>

                    <!-- Submit Button -->
                    <button id="prompt-submit-button" class="hud-button w-full">Confirm</button>
                </div>
                
                <!-- Error Message -->
                <p id="prompt-error" class="text-red-400 text-center hidden"></p>

                <!-- Success Message -->
                <div id="success-message" class="hidden text-center space-y-4">
                    <h3 class="font-hud-title text-2xl text-green-400">Assembly Complete!</h3>
                    <p id="success-name-display" class="text-xl">Welcome, Engineer.</p>
                    <p>Registration confirmed for the GDG Robotics Track.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const startContainer = document.getElementById('start-container');
        const startButton = document.getElementById('start-button');
        const mainUI = document.getElementById('main-ui');
        const assemblyContainer = document.getElementById('assembly-container');
        
        const promptContainer = document.getElementById('prompt-container');
        const promptBox = document.getElementById('prompt-box');
        const promptTitle = document.getElementById('prompt-title');
        const promptText = document.getElementById('prompt-text');
        const answerArea = document.getElementById('answer-area');
        
        const inputTextGroup = document.getElementById('input-text-group');
        const promptInput = document.getElementById('prompt-input');
        
        const inputChoiceGroup = document.getElementById('input-choice-group');
        const inputSelectGroup = document.getElementById('input-select-group');
        const promptSelect = document.getElementById('prompt-select');
        
        const submitButton = document.getElementById('prompt-submit-button');
        const promptError = document.getElementById('prompt-error');
        const successMessage = document.getElementById('success-message');
        const successNameDisplay = document.getElementById('success-name-display');

        // Robot Parts
        const robotParts = {
            Name: document.getElementById('robot-head'),
            Email: document.getElementById('robot-torso'),
            University: document.getElementById('robot-legs'), // Main part for all university steps
            College: document.getElementById('robot-legs'), // Re-use legs part
            UniversityID: document.getElementById('robot-legs'), // Re-use legs part
            Experience: document.getElementById('robot-arm-left'),
            Source: document.getElementById('robot-arm-right'),
            final: document.getElementById('robot-core')
        };

        // Get all robot parts for global alert state control
        const allRobotParts = document.querySelectorAll('.robot-part, #robot-core');


        // --- Google Script URL ---
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        //
        //  PASTE YOUR *OWN* GOOGLE APPS SCRIPT WEB APP URL HERE!
        //  If you use the placeholder, your form will NOT save data.
        //  Follow the `google_apps_script.gs.md` file to create your own.
        //
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxszHBBPrOTE0aLpXykaaTekbfyrGUcyGZUUa_cgxwR3GgdHCcfcthfaOGqhTF6Iq7d/exec'; 

        // --- Form State ---
        let currentQuestionIndex = 0;
        const formData = {};
        
        // --- Question Database ---
        // Note: Keys now match the Google Sheet Headers (case-sensitive)
        let questions = [
            { key: 'Name', prompt: 'What is your full name?', type: 'text', part: 'Name', placeholder: 'Enter your name...' },
            { key: 'Email', prompt: 'What is your email address?', type: 'email', part: 'Email', placeholder: 'Enter your email...' },
            { key: 'University', prompt: 'Which university are you at?', type: 'choice', choices: ['AAST', 'Other'], part: 'University' },
            // Conditional questions will be added here
            { key: 'Experience', prompt: 'What is your experience level?', type: 'select', options: ['Beginner (Just starting)', 'Intermediate (Built a few projects)', 'Advanced (Ready to compete)'], part: 'Experience' },
            { key: 'Source', prompt: 'How did you hear about us?', type: 'text', placeholder: 'e.g., Social media, friend...', part: 'Source' }
        ];

        // --- 1. Start Assembly ---
        startButton.addEventListener('click', () => {
            // Fade out start button
            startContainer.style.transition = 'opacity 0.5s ease-out';
            startContainer.style.opacity = 0;
            
            setTimeout(() => {
                startContainer.classList.add('hidden');
                
                // Show main UI
                mainUI.classList.remove('hidden');
                
                // Show first question
                promptContainer.classList.add('visible');
                
                // Start scanning animation
                assemblyContainer.classList.add('scanning');

                showNextQuestion();
            }, 500);
        });

        // --- 2. Form Logic ---
        function showNextQuestion() {
            // Clear any alert states when moving to the next question
            clearAlertState();

            // Animate the *previous* part locking into place
            if (currentQuestionIndex > 0) {
                const prevQuestion = questions[currentQuestionIndex - 1];

                // Special check for conditional logic. Only assemble legs ONCE.
                if (prevQuestion && robotParts[prevQuestion.part]) {
                    // Check if the part is one of the 'legs' parts
                    if (prevQuestion.part === 'University' || prevQuestion.part === 'College' || prevQuestion.part === 'UniversityID') {
                         // Only add 'assembled' if it's the *last* leg-related question or if the next is not a leg-related
                         const nextQuestion = questions[currentQuestionIndex]; 
                         if (!nextQuestion || (nextQuestion.part !== 'University' && nextQuestion.part !== 'College' && nextQuestion.part !== 'UniversityID')) {
                             robotParts.University.classList.add('assembled');
                         }
                    } else {
                        // Not a leg part, just assemble it
                        robotParts[prevQuestion.part].classList.add('assembled');
                    }
                }
            }

            // Check if we are done
            if (currentQuestionIndex >= questions.length) {
                submitFinalForm();
                return;
            }
            
            // Fade out the prompt box
            promptBox.style.opacity = 0;
            promptBox.style.transform = 'translateY(50px)'; // Move it down
            promptError.classList.add('hidden');


            // Wait for the part to assemble (0.5s) before showing the next question
            setTimeout(() => {
                const question = questions[currentQuestionIndex];
                
                // Update question number, accounting for dynamically added questions
                const totalQuestions = questions.length;
                promptTitle.textContent = `Registration Question (${currentQuestionIndex + 1}/${totalQuestions})`;
                promptText.textContent = question.prompt;

                // Hide all input types
                inputTextGroup.classList.add('hidden');
                inputChoiceGroup.classList.add('hidden');
                inputSelectGroup.classList.add('hidden');
                submitButton.classList.add('hidden');

                // Configure input type
                if (question.type === 'choice') {
                    inputChoiceGroup.classList.remove('hidden');
                    // Populate choices
                    inputChoiceGroup.innerHTML = ''; // Clear old ones
                    question.choices.forEach(choice => {
                        inputChoiceGroup.innerHTML += `<button class="hud-button" data-choice="${choice}">${choice}</button>`;
                    });
                
                } else if (question.type === 'select') {
                    inputSelectGroup.classList.remove('hidden');
                    submitButton.classList.remove('hidden');
                    submitButton.textContent = 'Confirm';
                    
                    promptSelect.innerHTML = ''; // Clear old options
                    // Add a default, non-selectable option
                    let defaultOptionText = "Select an option...";
                    if (question.key === 'Experience') defaultOptionText = "Select experience level...";
                    if (question.key === 'College') defaultOptionText = "Select your college...";

                    const defaultOption = document.createElement('option');
                    defaultOption.value = "";
                    defaultOption.textContent = defaultOptionText;
                    defaultOption.disabled = true;
                    defaultOption.selected = true;
                    promptSelect.appendChild(defaultOption);

                    question.options.forEach(opt => {
                        const optionEl = document.createElement('option');
                        optionEl.value = opt;
                        optionEl.textContent = opt;
                        promptSelect.appendChild(optionEl);
                    });
                    promptSelect.focus();

                } else { // Default to 'text', 'email', 'tel'
                    inputTextGroup.classList.remove('hidden');
                    submitButton.classList.remove('hidden');
                    submitButton.textContent = 'Confirm';
                    
                    promptInput.type = question.type || 'text';
                    promptInput.placeholder = question.placeholder || 'Enter response...';
                    promptInput.value = ''; // Clear input

                    // Remove old listener first to prevent duplicates
                    promptInput.removeEventListener('input', filterNumericInput);
                    // Add numeric filter for ID/Registration number questions
                    if (question.type === 'tel') {
                        promptInput.addEventListener('input', filterNumericInput);
                    }
                    
                    promptInput.focus();
                }
                
                // Fade in the prompt box
                promptBox.style.opacity = 1;
                promptBox.style.transform = 'translateY(0)'; // Move it up

            }, 500); // 0.5s delay for "next question" feel
        }
        
        // --- 3. Handle Answer Submission ---
        
        // Handle text/select input submission
        submitButton.addEventListener('click', () => {
            handleAnswerSubmission();
        });

        // Allow 'Enter' key submission for text inputs
        promptInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Stop default 'Enter' behavior (like submitting a form)
                handleAnswerSubmission();
            }
        });
        
        // Handle choice button submission
        inputChoiceGroup.addEventListener('click', (e) => {
            if (e.target.matches('.hud-button')) {
                const answer = e.target.dataset.choice;
                const questionKey = questions[currentQuestionIndex].key;
                saveAnswer(questionKey, answer);
            }
        });

        function handleAnswerSubmission() {
            const question = questions[currentQuestionIndex];
            let answer;

            if (question.type === 'select') {
                answer = promptSelect.value;
            } else {
                answer = promptInput.value;
            }
            
            // --- Validation ---
            if (!answer || (question.type === 'select' && answer === "")) {
                showError('A response is required.');
                return;
            }
            
            if (question.type === 'email' && !validateEmail(answer)) {
                showError('Please enter a valid email format.');
                return;
            }

            // Length validation for University ID
            if (question.key === 'UniversityID') {
                
                // The original choice (AAST or Other) is stored as the value of the first 'University' question
                const universityChoiceQ = questions.find(q => q.key === 'University' && q.type === 'choice');
                const originalChoice = universityChoiceQ ? formData[universityChoiceQ.key] : null;

                if (originalChoice === 'AAST' && answer.length !== 9) {
                    showError('AAST Registration Number must be 9 digits.');
                    return;
                }
                
                if (originalChoice === 'Other' && answer.length !== 11) {
                    showError('ID Number must be 11 digits.');
                    return;
                }
            }

            saveAnswer(question.key, answer);
        }

        function saveAnswer(key, answer) {
            // Get the question being answered
            const currentQ = questions[currentQuestionIndex];

            // Special case 1: Handle the "Other University Name" overwrite.
            const isUniversityNameQuestion = (key === 'University' && currentQ.type === 'text');

            if (isUniversityNameQuestion) {
                // The actual university name (e.g., 'Cairo University') is saved in the 'University' key
                formData['University'] = answer; 
            } else {
                formData[key] = answer; // Standard case
            }

            // --- Conditional Question Setup / Pruning ---
            // This logic MUST only run for the initial AAST/Other choice question (type: 'choice')
            if (key === 'University' && currentQ.type === 'choice') {
                
                // Remove all previous conditional questions (College, UniversityID, etc.)
                questions = questions.filter(q => 
                    q.key !== 'College' && 
                    q.key !== 'UniversityID' && 
                    // Filter out the *temporary* University name input if it exists from a previous 'Other' attempt
                    !(q.key === 'University' && q.type === 'text')
                );
                
                // Clear old conditional data from formData
                delete formData['College'];
                delete formData['UniversityID'];

                let conditionalQuestions = [];
                if (answer === 'AAST') {
                    // If AAST is chosen, the University key remains 'AAST'
                    conditionalQuestions = [
                        { key: 'College', prompt: 'Which college are you in?', type: 'select', options: ['Computer Science', 'Engineering', 'Management & Technology', 'Logistics', 'Archeology'], part: 'College' },
                        { key: 'UniversityID', prompt: 'Enter your 9-digit Registration Number.', type: 'tel', placeholder: '9 digits...', part: 'UniversityID' }
                    ];
                } else if (answer === 'Other') {
                    // This is the beginning of the "Other" path. We save the choice 'Other' for validation,
                    // but the name input below will overwrite the 'University' key with the actual name.
                    conditionalQuestions = [
                        // 1. Ask for the name of the "Other" university. Note: key is 'University' and type is 'text'
                        { key: 'University', prompt: 'What is your university\'s name?', type: 'text', placeholder: 'e.g., Cairo University', part: 'University' },
                        // 2. Then ask for college/faculty
                        { key: 'College', prompt: 'What is your college or faculty?', type: 'text', placeholder: 'e.g., Faculty of Engineering', part: 'College' },
                        // 3. Then ask for the ID Number
                        { key: 'UniversityID', prompt: 'Enter your 11-digit ID Number.', type: 'tel', placeholder: '11 digits...', part: 'UniversityID' }
                    ];
                }
                // Insert new questions *after* the current one
                questions.splice(currentQuestionIndex + 1, 0, ...conditionalQuestions);
            }
            
            // --- FIX: Explicit Leg Assembly after completing the University ID field ---
            if (key === 'UniversityID') {
                // This ensures the legs assemble correctly after the last University-related question is answered.
                robotParts.University.classList.add('assembled');
            }
            
            currentQuestionIndex++;
            showNextQuestion();
        }

        // --- 4. Final Submission to Google Sheet ---
        function submitFinalForm() {
            promptTitle.textContent = 'Finalizing Assembly...';
            promptText.textContent = 'Connecting components and logging registration...';
            answerArea.classList.add('hidden');
            submitButton.disabled = true;
            
            // Check for placeholder URL
            if (SCRIPT_URL.includes('PASTE_YOUR_NEW_WEB_APP_URL_HERE')) {
                console.warn("SCRIPT_URL is not set! Simulating success for testing.");
                // Simulate success for local testing
                setTimeout(() => {
                    robotParts.final.classList.add('assembled');
                    showSuccessScreen();
                }, 1000); 
                return; // Don't try to fetch
            }
            
            const finalFormData = new FormData();
            for (const key in formData) {
                // Skip the temporary 'Other' placeholder if the user entered a name afterwards
                if (key === 'University' && formData[key] === 'Other') {
                    // This should ideally be handled by the logic above, but this is a final cleanup
                    continue; 
                }
                finalFormData.append(key, formData[key]);
            }

            // --- Fetch call to Google Apps Script ---
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: finalFormData
            })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    // --- SUCCESS ---
                    // Light up the core
                    robotParts.final.classList.add('assembled');
                    // Show the success message screen
                    showSuccessScreen();

                } else if (data.result === 'duplicate') {
                    // --- DUPLICATE EMAIL ERROR ---
                    showError('This email is already registered. Please use a different one or contact support.');
                    triggerAlertState();
                    answerArea.classList.remove('hidden');
                    submitButton.disabled = false;
                    currentQuestionIndex = questions.findIndex(q => q.key === 'Email'); // Go back to email
                    // Re-show the email question, don't re-assemble previous part
                    promptBox.style.opacity = 0;
                    promptBox.style.transform = 'translateY(50px)';
                    setTimeout(() => {
                        // We must reset the index back 1 step so showNextQuestion processes the email as the *current* question
                        currentQuestionIndex = questions.findIndex(q => q.key === 'Email');
                        showNextQuestion(); // This will clear the alert
                        // Set the email input value back if it was an error
                        promptInput.value = formData.Email || ''; 
                    }, 500); 

                } else {
                    // --- OTHER SCRIPT ERROR ---
                    throw new Error(data.error || 'Unknown uplink error.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError(`Uplink failed. ${error.message}. Please try again.`);
                triggerAlertState(); // Trigger alert for generic errors
                answerArea.classList.remove('hidden');
                submitButton.disabled = false;
                
                // Find the last non-conditional question index to restart from (e.g., source)
                let lastQuestionIndex = questions.findIndex(q => q.key === 'Source');
                if (lastQuestionIndex === -1) lastQuestionIndex = questions.length - 1; 

                // If error happened early, go back to the current question for retry
                if (currentQuestionIndex > lastQuestionIndex) { 
                    currentQuestionIndex = lastQuestionIndex;
                }
                
                // De-assemble the last couple of parts for visual feedback on error
                robotParts.Experience.classList.remove('assembled');
                robotParts.Source.classList.remove('assembled');
                
                // Re-show the current question
                promptBox.style.opacity = 0;
                promptBox.style.transform = 'translateY(50px)';
                setTimeout(showNextQuestion, 500); 
            });
        }

        function showSuccessScreen() {
            answerArea.classList.add('hidden');
            promptError.classList.add('hidden'); // Hide error just in case
            
            // Fade out the prompt box completely
            promptBox.style.opacity = 0;
            promptBox.style.transform = 'translateY(50px)';
            
            // Stop scanning animation
            assemblyContainer.classList.remove('scanning');

            // NEW: Apply green success state to all assembled robot parts and the core
            allRobotParts.forEach(part => {
                // Ensure core is assembled if it wasn't already
                if (part.id === 'robot-core') {
                    part.classList.add('assembled'); // Ensure it's scaled up
                }
                part.classList.remove('alert'); // Remove red alert just in case
                part.classList.add('success'); // Turn it green
            });

            // After a moment, fade the prompt box back in with the success message
            setTimeout(() => {
                promptText.classList.add('hidden'); // Hide the "finalizing" text
                promptTitle.classList.add('hidden'); // Hide the "finalizing" title
                
                successMessage.classList.remove('hidden');
                successNameDisplay.textContent = `Welcome, Engineer ${formData.Name || ''}!`;
                
                promptBox.style.opacity = 1;
                promptBox.style.transform = 'translateY(0)';
            }, 500);
        }

        // --- 5. Utility Functions ---
        function showError(message) {
            promptError.textContent = message;
            promptError.classList.remove('hidden');
        }
        
        function validateEmail(email) {
            // Standard email regex
            const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,:;\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        function filterNumericInput(e) {
            // This function now only cleans the value.
            // It allows navigation keys to be pressed.
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        }

        // Add a more robust input event listener for filtering
        // This handles paste and other inputs better than keydown
        promptInput.addEventListener('input', (e) => {
            if (e.target.type === 'tel') {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            }
        });

        // --- Alert State Functions ---
        function triggerAlertState() {
            promptBox.classList.add('alert');
            allRobotParts.forEach(part => part.classList.add('alert'));
        }

        function clearAlertState() {
            promptBox.classList.remove('alert');
            allRobotParts.forEach(part => part.classList.remove('alert'));
        }

    </script>
</body>
</html>
